Fix an infinite resolution loop by resolving the top-level packages first. Also deduplicate the lines from the same requirement in the error output.
